<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에벤에셀 전기 - 거래 장부</title>
    
    <!-- PWA 설정 -->
    <meta name="description" content="전기 서비스 거래 내역 관리 시스템">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="에벤에셀 전기">
    
    <!-- 아이콘 -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>⚡ 에벤에셀 전기 거래 장부</h1>
            <p>전기 서비스 거래 내역 관리 시스템</p>
            
            <!-- 메인 네비게이션 -->
            <div class="main-nav">
                <button class="nav-tab active" data-view="stats">📊 통계</button>
                <button class="nav-tab" data-view="transactions">📋 거래 내역</button>
                <button class="nav-tab" data-view="expenses">💼 운영비</button>
                <button class="nav-tab" data-view="schedule">📅 작업 일정</button>
            </div>
        </div>

        <!-- 통계 화면 -->
        <div id="statsView" class="view-section active">
            <!-- 통계 표 -->
        <div class="stats-table-section">
            <div class="stats-header">
                <h2 class="section-title">📊 월별/지역별 통계</h2>
                <div class="stats-tabs">
                    <button class="stats-tab active" data-tab="monthly">월별 통계</button>
                    <button class="stats-tab" data-tab="location">지역별 통계</button>
                    <button class="stats-tab" data-tab="service">서비스별 통계</button>
                    <button class="stats-tab" data-tab="referral">유입 경로별 통계</button>
                </div>
            </div>

            <!-- 월별 통계 표 -->
            <div class="stats-table-container" id="monthlyStats">
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>월</th>
                            <th>거래 건수</th>
                            <th>총 매출</th>
                            <th>자재비</th>
                            <th>인부 비용</th>
                            <th>순이익</th>
                            <th>운영비</th>
                            <th>실순이익</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyStatsBody">
                        <tr>
                            <td colspan="8" class="loading">데이터를 불러오는 중...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 지역별 통계 표 -->
            <div class="stats-table-container hidden" id="locationStats">
                <div class="chart-container">
                    <canvas id="locationChart"></canvas>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>지역</th>
                            <th>거래 건수</th>
                            <th>총 매출</th>
                            <th>평균 단가</th>
                            <th>점유율</th>
                        </tr>
                    </thead>
                    <tbody id="locationStatsBody">
                        <tr>
                            <td colspan="5" class="loading">데이터를 불러오는 중...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 서비스별 통계 표 -->
            <div class="stats-table-container hidden" id="serviceStats">
                <div class="chart-container">
                    <canvas id="serviceChart"></canvas>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>서비스 유형</th>
                            <th>거래 건수</th>
                            <th>총 매출</th>
                            <th>평균 단가</th>
                            <th>점유율</th>
                        </tr>
                    </thead>
                    <tbody id="serviceStatsBody">
                        <tr>
                            <td colspan="5" class="loading">데이터를 불러오는 중...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 유입 경로별 통계 표 -->
            <div class="stats-table-container hidden" id="referralStats">
                <div class="chart-container">
                    <canvas id="referralChart"></canvas>
                </div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>유입 경로</th>
                            <th>거래 건수</th>
                            <th>총 매출</th>
                            <th>평균 단가</th>
                            <th>점유율</th>
                        </tr>
                    </thead>
                    <tbody id="referralStatsBody">
                        <tr>
                            <td colspan="5" class="loading">데이터를 불러오는 중...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
        <!-- 통계 화면 종료 -->

        <!-- 거래 내역 화면 -->
        <div id="transactionsView" class="view-section">
            <!-- 미수금 요약 -->
            <div class="unpaid-summary" id="unpaidSummary" style="display:none;" onclick="filterUnpaidOnly()">
                <div class="unpaid-summary-info">
                    <div class="unpaid-summary-icon">🔴</div>
                    <div class="unpaid-summary-text">
                        <h3>미수금 현황</h3>
                        <p id="unpaidCount">0건</p>
                    </div>
                </div>
                <div class="unpaid-summary-amount" id="unpaidAmount">₩0</div>
            </div>

            <!-- 거래 추가 버튼 -->
            <div class="add-transaction-btn-container">
                <button class="btn-add-transaction" id="openModalBtn">
                    ➕ 새 거래 등록
                </button>
            </div>

            <!-- 거래 목록 -->
            <div class="list-section">
                <h2 class="section-title">📊 거래 내역 목록</h2>
                
                <!-- 검색 및 필터 -->
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="🔍 고객명, 위치, 내용으로 검색...">
                </div>

                <div class="filter-container">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">전체</button>
                        <button class="filter-btn" data-filter="today">오늘</button>
                        <button class="filter-btn" data-filter="week">이번 주</button>
                        <button class="filter-btn" data-filter="month">이번 달</button>
                        <button class="filter-btn" data-filter="unpaid" style="border-color:#f44336;color:#f44336;">🔴 미수금</button>
                    </div>
                    
                    <div class="month-selector">
                        <select id="monthFilter">
                            <option value="">월별 조회</option>
                        </select>
                    </div>
                </div>

                <!-- 거래 목록 -->
                <div class="transaction-list" id="transactionList">
                    <div class="loading">데이터를 불러오는 중...</div>
                </div>
            </div>
        </div>
        <!-- 거래 내역 화면 종료 -->

        <!-- 지출 내역 화면 -->
        <div id="expensesView" class="view-section">
            <!-- 지출 요약 -->
            <div class="expense-summary-cards" id="expenseSummaryCards">
                <div class="expense-summary-card">
                    <div class="expense-summary-label">이번 달 운영비</div>
                    <div class="expense-summary-value" id="expenseMonthTotal">₩0</div>
                </div>
                <div class="expense-summary-card">
                    <div class="expense-summary-label">총 운영비</div>
                    <div class="expense-summary-value" id="expenseAllTotal">₩0</div>
                </div>
            </div>

            <!-- 지출 추가 버튼 -->
            <div class="add-transaction-btn-container">
                <button class="btn-add-transaction" id="openExpenseModalBtn" style="background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);">
                    ➕ 새 운영비 등록
                </button>
            </div>

            <!-- 지출 목록 -->
            <div class="list-section">
                <h2 class="section-title" style="border-bottom-color: #f44336;">💼 운영비 목록</h2>

                <div class="search-box">
                    <input type="text" id="expenseSearchInput" placeholder="🔍 내용, 카테고리로 검색...">
                </div>

                <div class="filter-container">
                    <div class="filter-buttons">
                        <button class="filter-btn expense-filter-btn active" data-filter="all">전체</button>
                        <button class="filter-btn expense-filter-btn" data-filter="month">이번 달</button>
                        <button class="filter-btn expense-filter-btn" data-filter="equipment">장비/공구</button>
                        <button class="filter-btn expense-filter-btn" data-filter="vehicle">차량/유류</button>
                        <button class="filter-btn expense-filter-btn" data-filter="operation">운영비</button>
                    </div>
                    <div class="month-selector">
                        <select id="expenseMonthFilter">
                            <option value="">월별 조회</option>
                        </select>
                    </div>
                </div>

                <div class="transaction-list" id="expenseList">
                    <div class="loading">데이터를 불러오는 중...</div>
                </div>
            </div>
        </div>
        <!-- 지출 내역 화면 종료 -->

        <!-- 지출 입력 모달 -->
        <div class="modal" id="expenseModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="section-title" style="border-bottom-color: #f44336;">💼 운영비 입력</h2>
                    <button class="modal-close" id="closeExpenseModalBtn">&times;</button>
                </div>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseDate">지출일 *</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseCategory">카테고리 *</label>
                            <select id="expenseCategory" required>
                                <option value="">카테고리 선택</option>
                                <option value="장비/공구">🔧 장비/공구</option>
                                <option value="자재 구매">📦 자재 구매</option>
                                <option value="차량/유류">🚗 차량/유류</option>
                                <option value="보험/세금">📋 보험/세금</option>
                                <option value="통신비">📱 통신비</option>
                                <option value="사무용품">🖊️ 사무용품</option>
                                <option value="식대/접대">🍽️ 식대/접대</option>
                                <option value="교육/자격증">📚 교육/자격증</option>
                                <option value="일반 운영비">💼 일반 운영비</option>
                                <option value="기타">📌 기타</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="expenseDescription">운영비 내용 *</label>
                        <input type="text" id="expenseDescription" required placeholder="예: 디지털 멀티미터 구매">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseAmount">금액 (원) *</label>
                            <input type="number" id="expenseAmount" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="expensePayMethod">결제 수단</label>
                            <select id="expensePayMethod">
                                <option value="카드">💳 카드</option>
                                <option value="현금">💵 현금</option>
                                <option value="계좌이체">🏦 계좌이체</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="expenseNotes">비고</label>
                        <textarea id="expenseNotes" placeholder="추가 메모 (구매처, 영수증 번호 등)"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="expenseSubmitBtn" style="background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);">
                        ✅ 운영비 저장
                    </button>
                </form>
            </div>
        </div>

        <!-- 지출 상세 모달 -->
        <div id="expenseDetailModal" class="modal">
            <div class="modal-content detail-modal-content">
                <div class="modal-header">
                    <h2>💼 운영비 상세</h2>
                    <span class="close-btn" id="closeExpenseDetailBtn">&times;</span>
                </div>
                <div id="expenseDetailContent" class="detail-content"></div>
                <div class="detail-actions" id="expenseDetailActions">
                    <button class="btn-action btn-edit-action" id="editExpenseBtn">✏️ 수정</button>
                    <button class="btn-action btn-delete-action" id="deleteExpenseBtn">🗑️ 삭제</button>
                </div>
            </div>
        </div>

        <!-- 작업 일정 화면 -->
        <div id="scheduleView" class="view-section">
            <div class="schedule-container">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prevMonth">◀</button>
                    <h2 class="calendar-title" id="calendarTitle">2026년 2월</h2>
                    <button class="calendar-nav-btn" id="nextMonth">▶</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- JS에서 요일 헤더 + 날짜 셀 모두 렌더링 -->
                </div>
                <!-- 선택된 날짜의 일정 목록 -->
                <div class="schedule-list-section" id="scheduleListSection" style="display:none;">
                    <h3 class="schedule-list-title" id="scheduleListTitle">일정 목록</h3>
                    <div class="schedule-list" id="scheduleList"></div>
                </div>
            </div>
        </div>
        <!-- 작업 일정 화면 종료 -->

        <!-- 일정 상세 모달 -->
        <div id="scheduleDetailModal" class="modal">
            <div class="modal-content detail-modal-content">
                <div class="modal-header">
                    <h2>📅 작업 일정 상세</h2>
                    <span class="close-btn" id="closeScheduleDetailBtn">&times;</span>
                </div>
                <div id="scheduleDetailContent" class="detail-content"></div>
                <div class="detail-actions" id="scheduleDetailActions">
                    <button class="btn-action btn-complete-action" id="completeScheduleBtn">✅ 완료</button>
                    <button class="btn-action btn-edit-action" id="editScheduleBtn">✏️ 수정</button>
                    <button class="btn-action btn-delete-action" id="deleteScheduleBtn">🗑️ 삭제</button>
                </div>
            </div>
        </div>

        <!-- 일정 수정 모달 -->
        <div class="modal" id="scheduleEditModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="section-title">✏️ 작업 일정 수정</h2>
                    <button class="modal-close" id="closeScheduleEditBtn">&times;</button>
                </div>
                <form id="scheduleEditForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editSchStartDate">시작일 *</label>
                            <input type="date" id="editSchStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="editSchEndDate">종료일</label>
                            <input type="date" id="editSchEndDate">
                            <small style="color:#999;font-size:0.8em;">하루 작업이면 비워두세요</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editSchStartTime">시작 시간 *</label>
                            <input type="time" id="editSchStartTime" required>
                        </div>
                        <div class="form-group">
                            <label for="editSchEndTime">종료 시간 (예상)</label>
                            <input type="time" id="editSchEndTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editSchServiceType">서비스 유형 *</label>
                            <select id="editSchServiceType" required>
                                <option value="">서비스 선택</option>
                                <option value="전기안전점검">전기안전점검</option>
                                <option value="차단기 교체">차단기 교체</option>
                                <option value="누전 수리">누전 수리</option>
                                <option value="접지공사">접지공사</option>
                                <option value="배선 수리">배선 수리</option>
                                <option value="콘센트/스위치 교체">콘센트/스위치 교체</option>
                                <option value="조명 설치">조명 설치</option>
                                <option value="소방전기">소방전기</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editSchLocation">위치 *</label>
                        <select id="editSchLocation" required>
                            <option value="">지역 선택</option>
                            <option value="용인시 처인구">용인시 처인구</option>
                            <option value="용인시 기흥구">용인시 기흥구</option>
                            <option value="용인시 수지구">용인시 수지구</option>
                            <option value="수원시 장안구">수원시 장안구</option>
                            <option value="수원시 권선구">수원시 권선구</option>
                            <option value="수원시 팔달구">수원시 팔달구</option>
                            <option value="수원시 영통구">수원시 영통구</option>
                            <option value="화성시 동탄">화성시 동탄</option>
                            <option value="화성시 봉담">화성시 봉담</option>
                            <option value="화성시 향남">화성시 향남</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSchDetailedLocation">상세 주소</label>
                        <input type="text" id="editSchDetailedLocation" placeholder="동/아파트명 등">
                    </div>
                    <div class="form-group">
                        <label for="editSchWorkContent">작업 내용 *</label>
                        <textarea id="editSchWorkContent" required placeholder="작업 내용을 상세히 입력하세요"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editSchMaterials">필요 자재</label>
                        <textarea id="editSchMaterials" placeholder="필요한 자재 목록을 입력하세요"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editSchNotes">일정 메모</label>
                        <textarea id="editSchNotes" placeholder="현장 주의사항, 준비물 등"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        ✅ 일정 수정 저장
                    </button>
                </form>
            </div>
        </div>

        <!-- 거래 입력 모달 -->
        <div class="modal" id="transactionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="section-title">📝 거래 내역 입력</h2>
                    <button class="modal-close" id="closeModalBtn">&times;</button>
                </div>
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="customerName">고객명 *</label>
                        <input type="text" id="customerName" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="phone">연락처 *</label>
                            <input type="text" id="phone" placeholder="01012345678" required maxlength="13">
                        </div>

                        <div class="form-group">
                            <label for="date">작업일 *</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="location">위치 *</label>
                        <select id="location" required>
                            <option value="">지역 선택</option>
                            <option value="용인시 처인구">용인시 처인구</option>
                            <option value="용인시 기흥구">용인시 기흥구</option>
                            <option value="용인시 수지구">용인시 수지구</option>
                            <option value="수원시 장안구">수원시 장안구</option>
                            <option value="수원시 권선구">수원시 권선구</option>
                            <option value="수원시 팔달구">수원시 팔달구</option>
                            <option value="수원시 영통구">수원시 영통구</option>
                            <option value="화성시 동탄">화성시 동탄</option>
                            <option value="화성시 봉담">화성시 봉담</option>
                            <option value="화성시 향남">화성시 향남</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="detailedLocation">상세 주소</label>
                        <input type="text" id="detailedLocation" placeholder="동/아파트명 등">
                    </div>

                    <div class="form-group">
                        <label for="serviceType">서비스 유형 *</label>
                        <select id="serviceType" required>
                            <option value="">서비스 선택</option>
                            <option value="전기안전점검">전기안전점검</option>
                            <option value="차단기 교체">차단기 교체</option>
                            <option value="누전 수리">누전 수리</option>
                            <option value="접지공사">접지공사</option>
                            <option value="배선 수리">배선 수리</option>
                            <option value="콘센트/스위치 교체">콘센트/스위치 교체</option>
                            <option value="조명 설치">조명 설치</option>
                            <option value="소방전기">소방전기</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="referralSource">유입 경로 *</label>
                        <select id="referralSource" required>
                            <option value="">유입 경로 선택</option>
                            <option value="네이버 블로그">네이버 블로그</option>
                            <option value="당근">당근</option>
                            <option value="숨고">숨고</option>
                            <option value="소개">소개</option>
                            <option value="네이버 검색">네이버 검색</option>
                            <option value="재방문">재방문</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>

                    <div class="form-group" id="referralDetailGroup" style="display: none;">
                        <label for="referralDetail">소개자/상세 정보</label>
                        <input type="text" id="referralDetail" placeholder="소개자 이름 또는 상세 정보 입력">
                    </div>

                    <div class="form-group">
                        <label for="content">작업 내용 *</label>
                        <textarea id="content" required placeholder="작업 내용을 상세히 입력하세요"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalCost">총 비용 (원) *</label>
                            <input type="number" id="totalCost" min="0" required>
                        </div>

                        <div class="form-group">
                            <label for="materialCost">자재비 (원)</label>
                            <input type="number" id="materialCost" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="laborCost">인부 비용 (원)</label>
                            <input type="number" id="laborCost" min="0" value="0">
                        </div>

                        <div class="form-group">
                            <label for="profit">순이익 (원)</label>
                            <input type="number" id="profit" min="0" value="0" readonly>
                        </div>
                    </div>

                    <!-- 수금 상태 -->
                    <div class="form-group">
                        <label>수금 상태 *</label>
                        <div class="payment-status-group">
                            <label class="payment-radio-label paid">
                                <input type="radio" name="paymentStatus" value="paid" checked>
                                <span class="payment-radio-text">💰 정산완료</span>
                            </label>
                            <label class="payment-radio-label unpaid">
                                <input type="radio" name="paymentStatus" value="unpaid">
                                <span class="payment-radio-text">🔴 미수금</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">비고</label>
                        <textarea id="notes" placeholder="추가 메모사항"></textarea>
                    </div>

                    <!-- 작업 일정 추가 토글 -->
                    <div class="schedule-toggle-section">
                        <label class="schedule-toggle-label">
                            <input type="checkbox" id="addScheduleToggle">
                            <span class="schedule-toggle-text">📅 작업 일정도 함께 등록</span>
                        </label>
                        <div class="schedule-fields" id="scheduleFields" style="display:none;">
                            <div class="schedule-fields-title">📅 작업 일정 정보</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="scheduleStartDate">시작일 *</label>
                                    <input type="date" id="scheduleStartDate">
                                </div>
                                <div class="form-group">
                                    <label for="scheduleEndDate">종료일</label>
                                    <input type="date" id="scheduleEndDate">
                                    <small style="color:#999;font-size:0.8em;">하루 작업이면 비워두세요</small>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="scheduleStartTime">시작 시간 *</label>
                                    <input type="time" id="scheduleStartTime">
                                </div>
                                <div class="form-group">
                                    <label for="scheduleEndTime">종료 시간 (예상)</label>
                                    <input type="time" id="scheduleEndTime">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="scheduleMaterials">필요 자재</label>
                                <textarea id="scheduleMaterials" placeholder="필요한 자재 목록을 입력하세요&#10;예: 2P 30A 차단기 x2, VVF 2.5sq 케이블 10m"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="scheduleNotes">일정 메모</label>
                                <textarea id="scheduleNotes" placeholder="현장 주의사항, 준비물 등"></textarea>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        ✅ 거래 내역 저장
                    </button>
                </form>
            </div>
        </div>

        <!-- 상세 보기 모달 -->
    <div id="detailModal" class="modal">
        <div class="modal-content detail-modal-content">
            <div class="modal-header">
                <h2>거래 상세 내역</h2>
                <span class="close-btn" id="closeDetailBtn">&times;</span>
            </div>

            <div id="detailContent" class="detail-content">
                <!-- JavaScript로 동적 생성 -->
            </div>

            <div class="detail-actions">
                <button class="btn-action btn-edit-action" id="editDetailBtn">
                    ✏️ 수정
                </button>
                <button class="btn-action btn-delete-action" id="deleteDetailBtn">
                    🗑️ 삭제
                </button>
            </div>
        </div>
    </div>
    <!-- container 종료 -->

    <!-- 거래명세서 작성 모달 -->
    <div class="modal" id="invoiceFormModal">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h2 class="section-title" style="border-bottom-color: #2196F3;">📄 거래명세서 / 견적서 작성</h2>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-primary" id="showInvoiceListBtn" style="background:#ff9800;font-size:0.8em;padding:6px 12px;">📋 저장목록</button>
                    <button class="modal-close" id="closeInvoiceFormBtn">&times;</button>
                </div>
            </div>
            <form id="invoiceForm">
                <!-- 문서 유형 선택 -->
                <div class="form-group">
                    <label>문서 유형</label>
                    <div class="payment-status-group">
                        <label class="payment-radio-label" style="border-color:#2196F3;">
                            <input type="radio" name="invoiceType" value="거래명세서" checked style="accent-color:#2196F3;">
                            <span class="payment-radio-text">📄 거래명세서</span>
                        </label>
                        <label class="payment-radio-label" style="border-color:#ff9800;">
                            <input type="radio" name="invoiceType" value="견적서" style="accent-color:#ff9800;">
                            <span class="payment-radio-text">📋 견적서</span>
                        </label>
                    </div>
                </div>

                <!-- 부가세 포함 여부 -->
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="invIncludeVat" style="width:18px;height:18px;accent-color:#2196F3;">
                        <span>부가세(VAT) 표기 포함</span>
                        <small style="color:#999;">(체크 시 공급가/부가세 분리 표기)</small>
                    </label>
                </div>

                <!-- 공급자 정보 -->
                <div class="invoice-section-title">🏢 공급자 정보</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invSupplierName">상호 *</label>
                        <input type="text" id="invSupplierName" value="에벤에셀 전기" required>
                    </div>
                    <div class="form-group">
                        <label for="invSupplierCeo">대표자</label>
                        <input type="text" id="invSupplierCeo" value="변경남">
                    </div>
                </div>
                <div class="form-group">
                    <label for="invSupplierAddr">주소</label>
                    <input type="text" id="invSupplierAddr" value="경기도 용인시 처인구 금학로 91">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invSupplierBizNo">사업자번호</label>
                        <input type="text" id="invSupplierBizNo" value="856-49-01003">
                    </div>
                    <div class="form-group">
                        <label for="invSupplierTel">연락처</label>
                        <input type="text" id="invSupplierTel" value="010-6595-5119">
                    </div>
                </div>

                <!-- 공급받는자 정보 -->
                <div class="invoice-section-title">👤 공급받는자 정보</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="invClientName">고객명(상호) *</label>
                        <input type="text" id="invClientName" required>
                    </div>
                    <div class="form-group">
                        <label for="invClientTel">연락처</label>
                        <input type="text" id="invClientTel">
                    </div>
                </div>
                <div class="form-group">
                    <label for="invClientAddr">주소</label>
                    <input type="text" id="invClientAddr">
                </div>

                <!-- 품목 -->
                <div class="invoice-section-title">📦 품목 내역</div>
                <div id="invoiceItemsContainer">
                    <div class="invoice-item-row" data-idx="0">
                        <div class="form-row">
                            <div class="form-group" style="flex:3;">
                                <label>품목명</label>
                                <input type="text" class="inv-item-name" placeholder="품목명">
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label>수량</label>
                                <input type="number" class="inv-item-qty" value="1" min="1">
                            </div>
                            <div class="form-group" style="flex:2;">
                                <label>단가</label>
                                <input type="number" class="inv-item-price" min="0" value="0">
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-add-item" id="addInvoiceItemBtn">+ 품목 추가</button>

                <!-- 비고 -->
                <div class="form-group" style="margin-top:15px;">
                    <label for="invNotes">비고</label>
                    <textarea id="invNotes" placeholder="추가 참고사항, 계좌번호 등">계좌번호 : 국민 806801-01-334721 (변경남)</textarea>
                </div>

                <button type="button" class="btn btn-primary" id="previewInvoiceBtn" style="background:linear-gradient(135deg,#2196F3,#1976D2);">
                    👁️ 미리보기
                </button>
            </form>
        </div>
    </div>

    <!-- 명세서 미리보기 모달 -->
    <div class="modal" id="invoicePreviewModal">
        <div class="modal-content" style="max-width:800px;padding:0;">
            <div class="modal-header" style="padding:15px 20px;">
                <h2 style="font-size:1.1em;">📄 미리보기</h2>
                <button class="modal-close" id="closeInvoicePreviewBtn">&times;</button>
            </div>
            <div id="invoicePreviewArea" style="padding:20px;background:#f5f5f5;overflow-y:auto;max-height:70vh;"></div>
            <div style="padding:15px 20px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;border-top:1px solid #e0e0e0;">
                <button class="btn btn-primary" id="saveInvoiceToDbBtn" style="background:#ff9800;">💾 저장</button>
                <button class="btn btn-primary" id="printInvoiceBtn" style="background:#2196F3;">🖨️ 인쇄</button>
                <button class="btn btn-primary" id="saveInvoiceImgBtn" style="background:#4CAF50;">📷 이미지 저장</button>
                <button class="btn btn-primary" id="closePreviewBtn2" style="background:#999;">닫기</button>
            </div>
        </div>
    </div>

    <!-- 저장된 명세서 목록 모달 -->
    <div class="modal" id="invoiceListModal">
        <div class="modal-content" style="max-width:650px;">
            <div class="modal-header">
                <h2 class="section-title" style="border-bottom-color:#ff9800;">📋 저장된 명세서 목록</h2>
                <button class="modal-close" id="closeInvoiceListBtn">&times;</button>
            </div>
            <div id="invoiceListContainer" style="max-height:65vh;overflow-y:auto;padding:10px 0;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- html2canvas (이미지 저장용) -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <script src="app-compat.js"></script>
</body>
</html>